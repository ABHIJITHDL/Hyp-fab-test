<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperledger Fabric Interface with Self-Signed Certificate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/0.10.0/forge.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="file"], textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result, #certificateDisplay {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
<h1>Hyperledger Fabric Interface with Self-Signed Certificate</h1>

<h2>Step 1: Generate Self-Signed Certificate</h2>
<div class="form-group">
    <label for="keyFile">Private Key File (PEM format):</label>
    <input type="file" id="keyFile" accept=".pem">
</div>
<div class="form-group">
    <label for="commonName">Common Name:</label>
    <input type="text" id="commonName" value="User1">
</div>
<button onclick="generateCertificate()">Generate Certificate</button>
<div id="certificateDisplay"></div>

<h2>Step 2: Submit Transaction</h2>
<div class="form-group">
    <label for="channelName">Channel Name:</label>
    <input type="text" id="channelName" value="mychannel">
</div>
<div class="form-group">
    <label for="chaincodeName">Chaincode Name:</label>
    <input type="text" id="chaincodeName" value="ehr">
</div>
<div class="form-group">
    <label for="functionName">Function Name:</label>
    <input type="text" id="functionName" value="getAllEHRRecordsForPatient">
</div>
<div class="form-group">
    <label for="args">Arguments:</label>
    <input type="text" id="args" value="P01">
</div>
<button onclick="submitTransaction()">Submit Transaction</button>
<div id="result"></div>

<script>
    let privateKey;
    let certificate;

    async function generateCertificate() {
        const keyFile = document.getElementById('keyFile').files[0];
        const commonName = document.getElementById('commonName').value;

        if (!keyFile) {
            alert('Please select a private key file.');
            return;
        }

        try {
            // Read the private key file
            const keyContent = await readFile(keyFile);
            privateKey = forge.pki.privateKeyFromPem(keyContent);

            // Generate a self-signed certificate
            const cert = forge.pki.createCertificate();
            cert.publicKey = forge.pki.rsa.setPublicKey(privateKey.n, privateKey.e);
            cert.serialNumber = '01' + forge.util.bytesToHex(forge.random.getBytesSync(19));
            cert.validity.notBefore = new Date();
            cert.validity.notAfter = new Date();
            cert.validity.notAfter.setFullYear(cert.validity.notBefore.getFullYear() + 1);

            const attrs = [{
                name: 'commonName',
                value: commonName
            }, {
                name: 'countryName',
                value: 'US'
            }, {
                shortName: 'ST',
                value: 'Virginia'
            }, {
                name: 'localityName',
                value: 'Blacksburg'
            }, {
                name: 'organizationName',
                value: 'Test'
            }, {
                shortName: 'OU',
                value: 'Test'
            }];
            cert.setSubject(attrs);
            cert.setIssuer(attrs);

            cert.setExtensions([{
                name: 'basicConstraints',
                cA: true
            }, {
                name: 'keyUsage',
                keyCertSign: true,
                digitalSignature: true,
                nonRepudiation: true,
                keyEncipherment: true,
                dataEncipherment: true
            }, {
                name: 'extKeyUsage',
                serverAuth: true,
                clientAuth: true,
                codeSigning: true,
                emailProtection: true,
                timeStamping: true
            }, {
                name: 'nsCertType',
                client: true,
                server: true,
                email: true,
                objsign: true,
                sslCA: true,
                emailCA: true,
                objCA: true
            }, {
                name: 'subjectAltName',
                altNames: [{
                    type: 6, // URI
                    value: 'http://example.org/webid#me'
                }, {
                    type: 7, // IP
                    ip: '127.0.0.1'
                }]
            }, {
                name: 'subjectKeyIdentifier'
            }]);

            // Self-sign the certificate
            cert.sign(privateKey);

            // Convert to PEM format
            certificate = forge.pki.certificateToPem(cert);

            // Display the certificate
            document.getElementById('certificateDisplay').innerText = certificate;
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('certificateDisplay').innerText = 'Failed to generate certificate. See console for details.';
        }
    }

    async function submitTransaction() {
        const channelName = document.getElementById('channelName').value;
        const chaincodeName = document.getElementById('chaincodeName').value;
        const functionName = document.getElementById('functionName').value;
        const args = document.getElementById('args').value;

        if (!certificate || !privateKey) {
            alert('Please generate a certificate first.');
            return;
        }

        // Sign the transaction data
        const md = forge.md.sha256.create();
        md.update(channelName + chaincodeName + functionName + args, 'utf8');
        const signature = privateKey.sign(md);

        const transactionData = {
            certificate: certificate,
            signature: forge.util.encode64(signature),
            channelName: channelName,
            chaincodeName: chaincodeName,
            functionName: functionName,
            args: args
        };

        try {
            const response = await fetch('/fabric/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(transactionData)
            });

            const result = await response.text();
            document.getElementById('result').innerText = result;
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('result').innerText = 'An error occurred. Please check the console for details.';
        }
    }

    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.onerror = (error) => reject(error);
            reader.readAsText(file);
        });
    }
</script>
</body>
</html>